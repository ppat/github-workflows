---
# yamllint disable rule:line-length
name: renovate

on:
  workflow_call:
    inputs:
      dry_run:
        required: false
        type: boolean
        default: true
      git_ref:
        required: true
        type: string
      log_level:
        required: false
        type: string
        default: info
      repository:
        required: true
        type: string
      timeout:
        required: false
        type: number
        default: 10
    secrets:
      renovate_app_id:
        required: true
      renovate_app_private_key:
        required: true
      dockerhub_username:
        required: true
      dockerhub_token:
        required: true

jobs:
  renovate:
    runs-on: ubuntu-24.04
    timeout-minutes: ${{ inputs.timeout }}
    steps:
    - name: Generate github app token for renovate
      uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547 # v1
      id: app-token
      with:
        app-id: ${{ secrets.renovate_app_id }}
        private-key: ${{ secrets.renovate_app_private_key }}
        owner: ${{ github.repository_owner }}

    - name: Checkout repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      with:
        persist-credentials: false
        repository: ${{ inputs.repository }}
        ref: ${{ inputs.git_ref }}
        token: "${{ steps.app-token.outputs.token }}"

    - name: Renovate
      uses: renovatebot/github-action@a889a8abcb11ef7feaafaf5e483ea01d4bf7774e # v43.0.5
      with:
        token: ${{ steps.app-token.outputs.token }}
        # renovate: datasource=github-releases depName=renovatebot/renovate
        renovate-version: "41.43.2"
      env:
        LOG_LEVEL: ${{ inputs.log_level }}
        RENOVATE_DRY_RUN: "${{ inputs.dry_run	== true && 'extract' || '' }}"
        RENOVATE_GIT_IGNORED_AUTHORS: "182250461+homelab-workflows-bot[bot]@users.noreply.github.com"
        # yamllint disable-line rule:indentation
        RENOVATE_HOST_RULES: >-
          [
            {
              "hostType": "docker",
              "username": "${{ secrets.dockerhub_username }}",
              "password": "${{ secrets.dockerhub_token }}"
            },
            {
              "hostType": "docker",
              "matchHost": "ghcr.io",
              "username": "${{ github.repository_owner }}",
              "password": "${{ steps.app-token.outputs.token }}"
            }
          ]
        RENOVATE_PLATFORM: 'github'
        RENOVATE_PLATFORM_COMMIT: 'true'
        RENOVATE_REPOSITORIES: "${{ inputs.repository }}"
        RENOVATE_REQUIRE_CONFIG: 'required'
        GIT_AUTHOR_NAME: ""
        GIT_AUTHOR_EMAIL: ""
        GIT_COMMITTER_NAME: ""
        GIT_COMMITTER_EMAIL: ""
