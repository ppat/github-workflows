---
# yamllint disable rule:line-length
name: commit-messages

on:
  workflow_call:
    inputs:
      git_ref:
        required: true
        type: string
      fetch_depth:
        required: true
        type: number
      from:
        required: true
        type: string
      to:
        required: true
        type: string

jobs:
  commit-messages:
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    steps:
    - name: Set fetch depth
      env:
        DEPTH: ${{ inputs.fetch_depth }}
      shell: bash
      # yamllint disable-line rule:indentation
      run: |
        echo "FETCH_DEPTH=$((DEPTH + 1))" >> $GITHUB_ENV

    - name: Checkout tools
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      with:
        fetch-depth: 0
        path: tools
        repository: ppat/github-workflows

    - name: Checkout current
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      with:
        fetch-depth: ${{ env.FETCH_DEPTH }}
        path: current
        repository: ${{ github.repository }}
        ref: ${{ inputs.git_ref }}

    - name: Cache mise
      uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4
      with:
        path: ~/.local/share/mise
        key: mise-${{runner.os}}-${{runner.arch}}-${{hashFiles('mise.toml')}}
        restore-keys: |
          mise-${{runner.os}}-${{runner.arch}}-

    - name: Setup mise
      env:
        # renovate: datasource=github-releases depName=jdx/mise
        MISE_VERSION: "v2025.1.1"
        MISE_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      working-directory: ./current
      # yamllint disable-line rule:indentation
      run: |
        mkdir -p ~/.config/mise
        ln -s $GITHUB_WORKSPACE/tools/mise.toml ~/.config/mise/config.toml
        curl https://mise.run | sh
        eval "$($HOME/.local/bin/mise activate bash)"
        $HOME/.local/bin/mise upgrade --yes
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        echo "$HOME/.local/share/mise/bin" >> $GITHUB_PATH
        echo "$HOME/.local/share/mise/shims" >> $GITHUB_PATH

    - name: Install node packages
      shell: bash
      working-directory: ./current
      # yamllint disable-line rule:indentation
      run: |
        if [[ ! -e bun.lockb ]]; then
          cp $GITHUB_WORKSPACE/tools/package.json .
          cp $GITHUB_WORKSPACE/tools/bun.lockb .
        fi
        bun install --frozen-lockfile

    - name: Lint commit messages
      shell: bash
      working-directory: ./current
      # yamllint disable-line rule:indentation
      run: |
        set -x
        bunx commitlint --color --from ${{ inputs.from }} --to ${{ inputs.to }} --verbose
