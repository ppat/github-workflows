---
# yamllint disable rule:line-length
name: renovate-config-check

on:
  workflow_call:
    inputs:
      git_ref:
        required: true
        type: string
      files:
        required: false
        type: string
        default: 'ALL'
      mise_ignore_cfg:
        required: false
        type: string
        default: ""
      mise_log_level:
        required: false
        type: string
        default: "info"

env:
  # renovate: datasource=github-releases depName=ppat/github-workflows
  GITHUB_WORKFLOWS_VERSION: "v2.2.0" # x-release-please-version
  # renovate: datasource=github-releases depName=renovatebot/renovate
  RENOVATE_VERSION: "41.148.1"

jobs:
  renovate-config-check:
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    steps:
    - name: Setup repository and tools
      uses: ppat/homelab-ops-actions/actions/setup-repository-tools@9ddd555bfe032fe96a292eb81d3a7dd81b675099 # v0.0.3
      with:
        current_git_ref: ${{ inputs.git_ref }}
        current_repository: ${{ github.repository }}
        mise_ignore_cfg: ${{ inputs.mise_ignore_cfg }}
        mise_log_level: ${{ inputs.mise_log_level }}
        # renovate: datasource=github-releases depName=jdx/mise
        mise_version: "v2025.10.7"
        token: ${{ secrets.GITHUB_TOKEN }}
        tools_git_ref: ${{ github.repository == 'ppat/github-workflows' && inputs.git_ref || env.GITHUB_WORKFLOWS_VERSION }}
        tools_repository: ppat/github-workflows

    - name: Setup additional tools
      shell: bash
      working-directory: ./current
      # yamllint disable-line rule:indentation
      run: |
        echo "Installing required tools..."
        mise use npm:renovate@${RENOVATE_VERSION}

    - name: Validate renovate config files
      env:
        RENOVATE_CONFIG_FILES: ${{ inputs.files }}
      shell: bash
      working-directory: ./current
      # yamllint disable-line rule:indentation
      run: |
        if [[ "${RENOVATE_CONFIG_FILES}" == "ALL" ]]; then
          echo "Validating main configuration..."
          echo ".github/renovate.json:"
          mise x npm:renovate@${RENOVATE_VERSION} -- renovate-config-validator .github/renovate.json | pr -t -o 4
          echo "Validating all 'extends' configuration files..."
          for rc in $(find .github/renovate -type f -name '*.json' | sort); do
            echo "${rc}:"
            mise x npm:renovate@${RENOVATE_VERSION} -- renovate-config-validator ${rc} | pr -t -o 4
          done
        else
          echo "Validating changed configuration files..."
          for rc in ${RENOVATE_CONFIG_FILES}; do
            echo "${rc}:"
            mise x npm:renovate@${RENOVATE_VERSION} -- renovate-config-validator ${rc} | pr -t -o 4
          done
        fi
