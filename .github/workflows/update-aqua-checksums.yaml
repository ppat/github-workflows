---
# yamllint disable rule:line-length
name: update-aqua-checksums

on:
  workflow_call:
    inputs:
      aqua_dirs:
        required: true
        type: string
      git_ref:
        required: true
        type: string
      mise_ignore_cfg:
        required: false
        type: string
        default: ""
      mise_log_level:
        required: false
        type: string
        default: "info"
      prune:
        required: false
        type: boolean
        default: true
      semantic_commit_type:
        required: false
        type: string
        default: "chore"
      semantic_commit_scope:
        required: false
        type: string
        default: "dev-tools"
    secrets:
      app_id:
        required: true
      app_private_key:
        required: true

jobs:
  update-aqua-checksums:
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    steps:
    - name: Generate github app token
      uses: actions/create-github-app-token@df432ceedc7162793a195dd1713ff69aefc7379e # v2
      id: app-token
      with:
        app-id: ${{ secrets.app_id }}
        private-key: ${{ secrets.app_private_key }}
        owner: ${{ github.repository_owner }}

    - name: Setup repository and tools
      uses: ppat/homelab-ops-actions/actions/setup-repository-tools@d51a74b412acbcee36d8071797e6c51ebe5e105b # v0.0.1
      with:
        current_fetch_depth: 0
        current_git_ref: ${{ inputs.git_ref }}
        current_persist_credentials:
        current_repository: ${{ github.repository }}
        extra_cache_path:
        extra_cache_key:
        extra_cache_restore_keys:
        mise_ignore_cfg: ${{ inputs.mise_ignore_cfg }}
        mise_log_level: ${{ inputs.mise_log_level }}
        # renovate: datasource=github-releases depName=jdx/mise
        mise_version: "v2025.7.32"
        token: ${{ steps.app-token.outputs.token }}
        tools_git_ref: main
        tools_repository: ppat/github-workflows

    - name: Update aqua-checksums.json
      env:
        AQUA_DIRS: ${{ inputs.aqua_dirs }}
        AQUA_GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        PRUNE: "${{ inputs.prune == 'true' && '-prune' || '' }}"
      shell: bash
      working-directory: ./current
      # yamllint disable-line rule:indentation
      run: |
        DIR_LIST=$(mktemp)
        if [[ "${AQUA_DIRS}" == "ALL" ]]; then
          find . -type f -name aqua.yaml -exec dirname {} \; | sort | uniq > ${DIR_LIST}
        else
          echo ${AQUA_DIRS} | tr ' ' '\n' > ${DIR_LIST}
        fi

        echo "Updating checksums..."
        while IFS= read -r dir; do
          echo "${dir}"
          pushd "${dir}" > /dev/null 2>&1
          aqua update-checksum ${PRUNE} 2>&1 | pr -t -o 4
          popd > /dev/null 2>&1
          echo
        done < ${DIR_LIST} | pr -t -o 4

        echo "Staging changes..."
        git add -A
        git status

    - name: Commit and push updated checksums
      uses: ppat/homelab-ops-actions/actions/create-signed-commit@d51a74b412acbcee36d8071797e6c51ebe5e105b # v0.0.1
      with:
        branch: ${{ inputs.git_ref }}
        commit_message: "${{ inputs.semantic_commit_type }}(${{ inputs.semantic_commit_scope }}): update aqua checksums"
        repository: ${{ github.repository }}
        token: ${{ steps.app-token.outputs.token }}
        working_directory:  ./current
