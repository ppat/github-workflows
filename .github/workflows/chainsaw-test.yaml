---
# yamllint disable rule:line-length
name: chainsaw-test

on:
  workflow_call:
    inputs:
      test_path:
        required: true
        type: string
      chainsaw_config:
        required: true
        type: string
      git_ref:
        required: true
        type: string
      kind_config:
        required: true
        type: string
      mise_ignore_cfg:
        required: false
        type: string
        default: ""
      mise_log_level:
        required: false
        type: string
        default: "info"
      timeout:
        required: false
        type: number
        default: 15

env:
  # renovate: datasource=github-releases depName=ppat/github-workflows
  GITHUB_WORKFLOWS_VERSION: "v2.2.0" # x-release-please-version
  # renovate: datasource=github-releases depName=kyverno/chainsaw
  CHAINSAW_VERSION: "v0.2.13"
  # renovate: datasource=github-releases depName=fluxcd/flux2
  FLUX_VERSION: "v2.6.4"
  # renovate: datasource=github-releases depName=kubernetes-sigs/kind
  KIND_VERSION: "0.30.0"
  # renovate: datasource=github-releases depName=kubernetes/kubectl
  KUBERNETES_VERSION: "v1.33.5"

jobs:
  test:
    runs-on: ubuntu-24.04
    timeout-minutes: ${{ inputs.timeout }}
    steps:
    - name: Setup repository and tools
      uses: ppat/homelab-ops-actions/actions/setup-repository-tools@9ddd555bfe032fe96a292eb81d3a7dd81b675099 # v0.0.3
      with:
        current_git_ref: ${{ inputs.git_ref }}
        current_repository: ${{ github.repository }}
        mise_ignore_cfg: ${{ inputs.mise_ignore_cfg }}
        mise_log_level: ${{ inputs.mise_log_level }}
        # renovate: datasource=github-releases depName=jdx/mise
        mise_version: "v2025.10.7"
        token: ${{ secrets.GITHUB_TOKEN }}
        tools_git_ref: ${{ github.repository == 'ppat/github-workflows' && inputs.git_ref || env.GITHUB_WORKFLOWS_VERSION }}
        tools_repository: ppat/github-workflows

    - name: Setup additional tools
      shell: bash
      working-directory: ./current
      # yamllint disable-line rule:indentation
      run: |
        echo "Installing required tools..."
        mise x kubectl@${KUBERNETES_VERSION} -- kubectl version --client --client
        mise x flux2@${FLUX_VERSION} -- flux version --client
        mise x kind@${KIND_VERSION} -- kind version
        mise x aqua:kyverno/chainsaw@${CHAINSAW_VERSION} -- chainsaw version

    - name: Setup kind cluster
      env:
        CLUSTER_NAME: dev
        # renovate-kind-image: datasource=docker versioning=docker
        CLUSTER_NODE_IMAGE: "kindest/node:v1.33.4@sha256:25a6018e48dfcaee478f4a59af81157a437f15e6e140bf103f85a2e7cd0cbbf2"
        CONFIG: ${{ inputs.kind_config }}
        WAIT: 60s
      shell: bash
      working-directory: ./current
      # yamllint disable-line rule:indentation
      run: |
        echo 'Creating kind cluster...'
        mise x kind@${KIND_VERSION} -- kind create cluster \
          --name=${CLUSTER_NAME} \
          --wait=${WAIT} \
          --image=${CLUSTER_NODE_IMAGE} \
          --config=${CONFIG}
        mise x kubectl@${KUBERNETES_VERSION} -- kubectl version

    - name: Install flux in kind cluster
      shell: bash
      run: |
        mise x flux2@${FLUX_VERSION} -- flux install --version ${FLUX_VERSION} --log-level debug
        mise x flux2@${FLUX_VERSION} -- flux version

    - name: Run Chainsaw Tests
      env:
        GIT_URL: https://github.com/${{ github.repository }}.git
        GIT_REF: ${{ inputs.git_ref }}
        CHAINSAW_CONFIG: ${{ inputs.chainsaw_config }}
        TEST_PATH: ${{ inputs.test_path }}
      shell: bash
      working-directory: ./current
      # yamllint disable-line rule:indentation
      run: |
        if [[ "${GIT_REF}" == "refs/heads/main" ]]; then
          GIT_BRANCH="main"
        else
          GIT_BRANCH="${GIT_REF}"
        fi

        cat > /tmp/values-ci.yaml <<EOF
        git:
          url: '${GIT_URL}'
          branch: '${GIT_BRANCH}'
        EOF

        cat /tmp/values-ci.yaml

        # Run tests with combined values
        set -x
        mise x aqua:kyverno/chainsaw@${CHAINSAW_VERSION} -- chainsaw test ${TEST_PATH} \
          --config ${CHAINSAW_CONFIG} \
          --values /tmp/values-ci.yaml \
          --fail-fast
